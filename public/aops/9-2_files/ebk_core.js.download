AoPS.Utils.initKeyChain(AoPS,"Ebooks","Url"),AoPS.Ebooks.Url=function(o){var e=AoPS.UrlTable;return{main:new e.Table({data:{index:"",book_notrail:":booksku",book:":booksku/*bookurl",book_preview:":booksku/preview",edge:"edge/:booksku/:sectioncode",error:"error"},root_url:"/ebooks/",image_path:"/ebooks/images/"}),createBookTable:function(o){return o=o||{},new e.Table({data:{index:"",last:"last",section:":sectioncode",section_label:":sectioncode/label/:labelid",section_paragraph:":sectioncode/par/:paragraphid",section_problem:":sectioncode/prob/:problemid",label:"label/:labelid",paragraph:"par/:parid",problem:"prob/:probid"},root_url:o.root_url||"/ebooks/"+o.book_code+"/",image_path:"/ebooks/images/"})}}}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Base"),AoPS.Ebooks.Models.Base=function(e){var a=AoPS.Ajax,t=AoPS.BackboneExtras,s=AoPS.LoadUtils,o=AoPS.bootstrap_data||{};e.HARD_HTML='<span class="ebk-hard-symbol">&#9733;</span>',e.ajax=new a.ScriptRunner("/m/ebooks/ajax.php",{timeout:o.ebk_is_admin?59e3:2e4});var i={};_.extend(i,s.LoaderMixin,{setFields:function(e,a){if(e){var t=e[this.id_attribute];_.isUndefined(t)||(this.id=this.nonnumeric_ids?t:parseInt(t,10));var s={};_.each(e,(function(e,t){var o=this.defaults[t];this.defaults.hasOwnProperty(t)&&!_.contains(a,t)&&(_.isNumber(o)?s[t]=parseFloat(e,10):_.isBoolean(o)?s[t]=!!e:s[t]=e)}),this),this.set(s)}},unpack:function(e){e&&this.setFields(e)}}),e.BaseModel=Backbone.Model.extend(i);var n={};return _.extend(n,t.AutocreateMixin,{unpackAll:function(e,a){a=a||"id";var t=[];return _.each(e||[],(function(e){var s=e[a],o=this.getOrCreate(s,{delay_add:!0});o.unpack(e),t.push(o)}),this),this.add(t),t}}),e.BaseCollection=Backbone.Collection.extend(n),e}(AoPS.Ebooks.Models.Base);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","BaseSection"),AoPS.Ebooks.Models.BaseSection=AoPS.Ebooks.Models.Base.BaseModel.extend({id_attribute:"fragment_id",defaults:{fragment_code:"",number:"",title_html:"",order:-1,html:"",is_hard:!1,edge:!1,previous_id:0,next_id:0,previous_code:"",next_code:"",alcumus_subject_id:0,alcumus_topic_id:0}});
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","EdgeSection"),AoPS.Ebooks.Models.EdgeSection=function(){var e=AoPS.LoadUtils,t=AoPS.Ebooks.Models.Base;return AoPS.Ebooks.Models.BaseSection.extend({initialize:function(){this.set("edge",!0)},requestLoad:function(t,o){this.section_loader||(this.section_loader=new e.LoadManager({loadHandler:this.loadContent,context:this})),t=e.makeCallback(t,o),this.get("book").requestLoad((function(e,o){if(!e)return t(e,o);this.section_loader.requestLoad(t)}),this)},reload:function(e,t){this.section_loader&&this.section_loader.forceReload(),this.requestLoad(e,t)},loadContent:function(e){var o=this.get("book");t.ajax.run("load_edge_section",{user_id:o.get("master").get("user_id"),book_id:o.id,section_code:this.get("fragment_code")||this.id},(function(t,i){if(!t)return o.get("edge_sections").remove(this.id),e(t,i);o.unpack(i.response.book),e(t,{})}))},getNumberTitle:function(e){return(this.get("fragment_code")||this.id)+" "+this.get("title_html")}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Section"),AoPS.Ebooks.Models.Section=function(){var t=AoPS.LoadUtils,e=AoPS.Ebooks.Models.Base;return AoPS.Ebooks.Models.BaseSection.extend({requestLoad:function(t,e){this.get("book").requestSectionContent(this.id,t,e)},reload:function(e,i){this.get("html")&&(e=t.makeCallback(e,i),this.loadContent(!0,e))},loadContent:function(t,i){var o=this.get("book");e.ajax.run("load_section",{user_id:o.get("master").get("user_id"),book_id:o.id,section_id:this.id,rerender:t?1:0},(function(t,e){if(!t)return i(t,e);o.unpack(e.response.book),i(t,{})}),{no_filter:!0})},markViewed:function(){var t=this.get("book");e.ajax.run("mark_section_viewed",{user_id:t.get("master").get("user_id"),book_id:t.id,section_id:this.id},(function(){}))},unpack:function(t){if(t){var e=this.get("book");this.setFields(t),this.set("is_hard",!!t.is_hard),t.hasOwnProperty("chapter_id")&&(this.set("chapter",e.get("chapters").getOrCreate(t.chapter_id)),this.get("chapter").get("sections").add(this)),t.html&&e.markSectionAsLoaded(this.id)}},getRelativeSectionId:function(t,e){var i=this.get("book").get("sections"),o=i.get(this.get("previous_id")),s=i.get(this.get("next_id"));return"chapter"===t?this.get("chapter").getRelativeSectionId(e):e<0&&o?o.id:e>0&&s?s.id:0===e?this.id:void 0},getOrCreateProblem:function(t){return this.get("book").get("problems").getOrCreate(t)},getOrCreateHint:function(t){return this.get("book").get("hints").getOrCreate(t)},getTags:function(){var t=this.get("chapter").getTags(),e=this.get("number"),i=e?"Section "+e:this.get("title_html");return"Review Problems"!==i&&"Challenge Problems"!==i||(i="Chapter "+this.get("chapter").get("number")+" "+i),"Book"===t[0]&&(i="Book "+i),t.concat([i])},getNumberTitle:function(t){t=t||{};var i,o=this.get("chapter").get("number"),s=this.get("number"),r=this.get("is_hard")&&!t.plain?e.HARD_HTML:"";return(i=t.full&&s?"Section "+s+r+":":s?s+r:t.unique&&o?"Ch."+o+r:r)+(i.length?" ":"")+this.get("title_html")},getAlcumusUrl:function(){var t=this.get("alcumus_subject_id"),e=this.get("alcumus_topic_id");if(t&&e)return"/alcumus/set_focus/"+t+"/subject/"+e},getFeedData:function(t){var e=this.get("book"),i=this.getTags();return e.getFirstSectionId()===this.id?{main_url:(i=e.getTags())[0]||"",subtitle:e.get("title"),category_id:e.get("cmty_category_id"),tags:i}:{main_url:t.getUrl("section",this.get("fragment_code")),subtitle:this.getNumberTitle({unique:!0}),category_id:e.get("cmty_category_id"),tags:i}}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Chapter"),AoPS.Ebooks.Models.Chapter=function(){var t=AoPS.Ebooks.Models.Base;return t.BaseModel.extend({id_attribute:"fragment_id",defaults:{fragment_code:"",number:"",title_html:"",is_hard:!1,order:-1,previous_id:0,next_id:0},initialize:function(){var e=new t.BaseCollection;this.set("paragraph_table",{}),this.set("label_table",{}),this.set("sections",e),e.setCreateFunction(_.bind((function(t){var e=this.get("book").get("sections").getOrCreate(t);return e.set("chapter",this),e}),this)),e.comparator="order"},getTags:function(){var t=this.get("book").getTags(),e=this.get("number"),i=e?"Chapter "+e:this.get("title_html");return"Book"===t[0]&&(i="Book "+i),t.concat([i])},getTocNumber:function(){var t=this.get("number");return t||(this.get("previous_id")?"E":"C")},getNumberTitle:function(e){e=e||{};var i,o=this.get("number"),r=this.get("is_hard")&&!e.plain?t.HARD_HTML:"";return(i=e.full&&o?"Chapter "+o+r+":":o?o+r+".":r)+(i.length?" ":"")+this.get("title_html")},getRelativeSectionId:function(t){var e=this.get("book").get("chapters"),i=e.get(this.get("previous_id")),o=e.get(this.get("next_id"));return t<0&&i?i.getFirstSectionId():t>0&&o?o.getFirstSectionId():0===t?this.getFirstSectionId():void 0},getFirstSectionId:function(){var t=this.get("sections").at(0);return t&&t.id},sortSections:function(){this.get("sections").sort()}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Problem"),AoPS.Ebooks.Models.Problem=function(){var s=AoPS.LoadUtils,e=AoPS.Ebooks.Models.Base;return e.BaseModel.extend({id_attribute:"problem_id",defaults:{number:"",has_soln_perms:!1,has_submitted:!1,submission_before:"",submission_before_html:"",submission_after:"",submission_after_html:"",solution_html:""},submitProblem:function(i,o,t,r){if((i=_.isString(i)&&i.trim())||""===i){t=s.makeCallback(t,r);var n=this.get("book");e.ajax.run("save_problem",{user_id:n.get("master").get("user_id"),book_id:n.id,problem_id:this.id,submission:i,is_final:o?1:0},_.bind((function(s,e){if(!s)return t(s,e);this.unpack(e.response.problem),t(s,e.response.problem)}),this))}},resetProblem:function(i,o){i=s.makeCallback(i,o);var t=this.get("book");e.ajax.run("reset_problem",{user_id:t.get("master").get("user_id"),book_id:t.id,problem_id:this.id},_.bind((function(s,e){if(!s)return i(s,e);this.set({has_submitted:!1,submission_before:"",submission_before_html:"",submission_after:"",submission_after_html:"",solution_html:""}),this.unpack(e.response.problem),i(s,e.response.problem)}),this))},resetProblemLocal:function(e,i){e=s.makeCallback(e,i),setTimeout(_.bind((function(){this.set({has_submitted:!1,submission_before:"",submission_after:"",solution_html:""}),e(!0)}),this),0)},viewPreviewSolution:function(i,o,t){var r=this.get("book");if(r.get("has_access"))return this.submitProblem(i,!0,o,t);o=s.makeCallback(o,t),e.ajax.run("view_preview_solution",{user_id:r.get("master").get("user_id"),book_id:r.id,problem_id:this.id},_.bind((function(s,e){if(!s)return o(s,e);this.unpack(e.response.problem),this.set("submission_before",i),this.set("has_submitted",!0),this.set("has_soln_perms",!0),o(s,e.response.problem)}),this))}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Hint"),AoPS.Ebooks.Models.Hint=function(){var i=AoPS.LoadUtils,t=AoPS.Ebooks.Models.Base;return t.BaseModel.extend({id_attribute:"hint_id",defaults:{has_viewed:!1,is_shown:!1,hint_html:""},view:function(e,s){if(e=i.makeCallback(e,s),this.get("has_viewed")&&this.get("hint_html"))return this.set("is_shown",!0),void setTimeout(e(!0,{}),1);var o=this.get("book");t.ajax.run("view_hint",{user_id:o.get("master").get("user_id"),book_id:o.id,hint_id:this.id},_.bind((function(i,t){if(!i)return e(i,t);this.unpack(t.response.hint),this.set("is_shown",!0),e(i,{})}),this))}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Book"),AoPS.Ebooks.Models.Book=function(){var e=AoPS.LoadUtils,t=AoPS.Ebooks.Models.Base,s=AoPS.Ebooks.Models,i=AoPS.Ebooks.Url.main;return t.BaseModel.extend({id_attribute:"book_id",defaults:{has_access:!1,can_cancel:!1,code:"",cmty_category_id:0,store_sku:"",title:"",short_title:"",authors:[],last_viewed_section_id:0,start_access_at:"",section_code_table:null},initialize:function(){this.set("label_fragments",{}),this.set("paragraph_fragments",{}),this.set("problem_fragments",{}),this.setLoader(new e.LoadManager({loadHandler:this.loadBook,context:this})),this.section_loader=new e.SingleLoadQueue({loadHandler:this.loadSectionContent,context:this}),this.set("free_section",null);var i=this;function r(e,s,r){var o=new t.BaseCollection;i.set(e,o),o.setCreateFunction((function(e){return new s({id:e,book:i})})),r&&(o.comparator=r)}r("problems",s.Problem),r("hints",s.Hint),r("chapters",s.Chapter,"order"),r("sections",s.Section,"order"),r("edge_sections",s.EdgeSection)},loadBook:function(e){var t=this.get("master");t.requestLoad((function(s,i){if(!s)return t.get("books").remove(this.id),e(s,i);this.get("title")?e(!0,{}):(t.get("books").remove(this.id),e(!1,{error_code:"E_NOT_FOUND",error_msg:"The requested book was not found, or you do not have access to it."}))}),this)},unpack:function(e){e&&(this.setFields(e),_.extend(this.get("label_fragments"),e.label_fragments||{}),_.extend(this.get("paragraph_fragments"),e.paragraph_fragments||{}),_.extend(this.get("problem_fragments"),e.problem_fragments||{}),this.get("chapters").unpackAll(e.chapters,"fragment_id"),this.get("chapters").sort(),this.get("sections").unpackAll(e.sections,"fragment_id"),this.get("sections").sort(),_.invoke(this.get("chapters").models,"sortSections"),this.get("edge_sections").unpackAll(e.edge_sections,"fragment_code"),this.get("problems").unpackAll(e.problems,"problem_id"),this.get("hints").unpackAll(e.hints,"hint_id"),this.markAsLoaded(!0))},requestSectionContent:function(e,t,s){this.requestLoad((function(i){i&&this.section_loader.requestLoad(e,t,s)}),this)},markSectionAsLoaded:function(e,t){this.section_loader.markAsLoaded(e,!0,t||{})},loadSectionContent:function(e,t){var s=this.get("sections").get(e);s?s.loadContent(!1,t):t(!1,{error_code:"E_NOT_FOUND",error_msg:"The requested section does not exist."})},loadFreePreview:function(s,i){function r(e,t){if(!e)return s(e,t);this.unpack(t.response.book);var i=t.response.free_section.fragment_id,r=this.get("sections").getOrCreate(i);this.set("free_section",r),r.unpack(t.response.free_section),s(e,r)}s=e.makeCallback(s,i),this.get("free_section")?setTimeout(_.partial(s,!0,this.get("free_section")),0):this.requestLoad((function(e,i){if(!e)return s(e,i);t.ajax.run("load_free_preview",{user_id:this.get("master").get("user_id"),book_id:this.id},_.bind(r,this))}),this)},cancelPurchase:function(s,i,r){i=e.makeCallback(i,r),t.ajax.run("cancel_purchase",{user_id:this.get("master").get("user_id"),book_id:this.id,reason:s||""},i)},findLabel:function(s,i,r){var o=this.get("label_fragments");function n(e,t){if(!e)return i(e,t);this.unpack(t.response.book),i(e,t.response.fragment_id)}i=e.makeCallback(i,r);var a=o[s];a?setTimeout(_.partial(i,!0,a),0):this.requestLoad((function(e,r){if(!e)return i(e,r);t.ajax.run("find_label",{user_id:this.get("master").get("user_id"),book_id:this.id,label_id:s},_.bind(n,this))}),this)},findParagraph:function(s,i,r){var o=this.get("paragraph_fragments");function n(e,t){if(!e)return i(e,t);this.unpack(t.response.book),i(e,t.response.fragment_id)}i=e.makeCallback(i,r);var a=o[s];a?setTimeout(_.partial(i,!0,a),0):this.requestLoad((function(e,r){if(!e)return i(e,r);t.ajax.run("find_paragraph",{user_id:this.get("master").get("user_id"),book_id:this.id,paragraph_id:s},_.bind(n,this))}),this)},findProblem:function(s,i,r){var o=this.get("problem_fragments");function n(e,t){if(!e)return i(e,t);this.unpack(t.response.book),i(e,t.response.fragment_id)}i=e.makeCallback(i,r);var a=o[s];a?setTimeout(_.partial(i,!0,a),0):this.requestLoad((function(e,r){if(!e)return i(e,r);t.ajax.run("find_problem",{user_id:this.get("master").get("user_id"),book_id:this.id,problem_id:s},_.bind(n,this))}),this)},findSearchMatches:function(s,i,r){i=e.makeCallback(i,r),t.ajax.run("search_matches",{user_id:this.get("master").get("user_id"),book_id:this.id,search:s},_.bind((function(e,t){if(!e)return i(e,t);i(!0,t.response.search_matches)}),this))},findSearchResults:function(s,i,r){i=e.makeCallback(i,r),t.ajax.run("search_results",{user_id:this.get("master").get("user_id"),book_id:this.id,search:s},_.bind((function(e,t){if(!e)return i(e,t);t=_.map(t.response.search_results,(function(e){var t=this.getAsSectionId(e.fragment_id);return t?{search:s,section_id:t,paragraph_id:e.paragraph_id,order:this.get("sections").get(t).get("order")}:null}),this),t=_.sortBy(_.compact(t),"order"),i(!0,t)}),this))},getFragmentIdFromCode:function(e){var t=this.get("section_code_table");return t&&t[e]||0},getFragmentCodeFromId:function(e){e=this.getAsSectionId(e);var t=this.get("sections").get(e);return t&&t.get("fragment_code")},getTags:function(){return this.get("master").get("is_embedded")?["Book"]:[]},getAsSectionId:function(e){var t=this.get("chapters").get(e);return t?t.getFirstSectionId():e},getFirstSectionId:function(){return this.get("sections").at(0)&&this.get("sections").at(0).id},getByLine:function(){return this.get("authors")?"by "+this.get("authors").join(", "):""},getCoverUrl:function(){return i.getImage(this.get("code")+"-cover.png")},resetAllProblems:function(s,i){s=e.makeCallback(s,i),t.ajax.run("reset_all_problems",{user_id:this.get("master").get("user_id"),book_id:this.id},s)}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Models","Master"),AoPS.Ebooks.Models.Master=function(){var o=AoPS.LoadUtils,e=AoPS.Ebooks.Models.Base,s=AoPS.Ebooks.Models;return e.BaseModel.extend({defaults:{user_id:-1,is_admin:!1,is_offline:!1,is_embedded:!1,sku_table:null},initialize:function(){this.set("books",new e.BaseCollection),this.get("books").setCreateFunction(_.bind((function(o){return new s.Book({id:o,master:this})}),this)),this.setLoader(new o.LoadManager({loadHandler:this.loadBookList,context:this}))},getAccessibleBooks:function(){return new Backbone.Collection(this.get("books").filter((function(o){return o.get("has_access")})))},getBookIdFromSku:function(o){var e=this.get("sku_table");return e&&e[o]||0},loadBookList:function(o){e.ajax.run("load_user_book_list",{user_id:this.get("user_id")},_.bind((function(e,s){if(!e)return o(e,s);this.unpack(s.response),o(e,{})}),this))},unpack:function(o){o&&(this.setFields(o),this.get("books").unpackAll(o.books,"book_id"),this.markAsLoaded(!0))}})}();
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Base"),AoPS.Ebooks.Views.Base=function(e){var t=AoPS.View.compileTemplate,r=AoPS.BackboneExtras,o=AoPS.Ui,i=AoPS.Ui.Modal,n=AoPS.LoadUtils,s=AoPS.Ebooks.Url.main;Handlebars.registerHelper("ebkurl",_.bind(s.getUrl,s)),e.getErrorFooter=function(e){return"E_UNREGISTERED"===e.error_code?"Please either sign in or register a new account with our website by using the links in the top right. Your account will need to have permission to view our online books before you can continue using this page.":"E_NO_AUTH"===e.error_code?"Please sign back in using the links in the top right before continuing.":""},e.showSpecialError=function(e,t){if("E_UNREGISTERED"===e.error_code)o.buildLoginConfirm("In order to use Ebooks, you must be signed into an account that has obtained access to our online books. If you are one of our online book customers, please sign in.",t);else{if("E_NOT_INITIALIZED"!==e.error_code)return!1;AoPS.Initialize.display()}return!0},e.showModalError=function(t,r,o){if(o=o||{},!e.showSpecialError(r,o)){t=t?t+" ":"";var n=r.error_msg;n=n?n+" ":"";var s=e.getErrorFooter(r);i.showAlert(t+n+s,o)}},e.showFreePreviewModal=function(e,r){var o=t("#ebk-cms-preview-base"),n=t("#ebk-cms-"+e);i.showAlert("<p>"+n()+"</p>\n<p>"+o({store_sku:r.get("store_sku")})+"</p>")};var a=_.extend({},r.TemplateMixin,r.SubviewMixin,{preRender:function(){},getContext:function(){return{}},whenRendered:function(e,t){e=n.makeCallback(e,t),this.rendered?setTimeout(e,0):(this.render_callbacks=this.render_callbacks||[],this.render_callbacks.push(e))},setRendered:function(e){this.rendered=!!e,e&&this.render_callbacks&&this.render_callbacks.length&&setTimeout(_.bind((function(){_.each(this.render_callbacks,(function(e){e()})),this.render_callbacks=[]}),this),0)},render:function(){this.preRender(),this.detachAllSubviews(),this.renderTemplate(this.getContext()),this.attachAllSubviews(),this.removeHandlebarsLocationMarkers(),this.postRender(),this.setRendered(!0)},renderSimple:function(e){this.detachAllSubviews(),this.renderTopOnly(),this.$el.html(e||""),this.setRendered(!0)},renderLoading:function(e){this.renderSimple(),e=_.isUndefined(e)?AoPS.Page.$loader.clone():e,this.$el.append(e||""),this.setRendered(!1)},renderError:function(t){_.contains(["E_UNREGISTERED","E_SESSION_ENDED"],t.error_code)?(e.showSpecialError(t),this.renderSimple(this.getErrorBox(t))):this.renderSimple(this.getErrorBox(t)),this.setRendered(!1)},getErrorBox:function(r){var o=r&&r.error_msg;return t("#ebk-tpl-error-box")({error_msg:o||"",footer:r.footer||e.getErrorFooter(r)})},postRender:function(){},onClose:function(){this.stopListening(),this.closeAllSubviews()}});return e.BaseView=Backbone.View.extend(a),e.makeAopsFontText=function(e){return'<span class="aops-font">'+e+"</span>"},e.enableHrefs=function(e,t){var r=t?"data-offline-href":"href",o=t?"href":"data-offline-href";(e=e||$("body")).find("a["+r+"]").each((function(){var e=$(this);e.attr(o,e.attr(r)),e.removeAttr(r)}))},e.Placeholder=e.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-placeholder"),this.classes=e.classes||[],this.render()},postRender:function(){this.$el.addClass(this.classes.join(" "))}}),e.CopyTextModal=e.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-copy-text-modal"),this.description=e.description,this.text=e.text,this.render()},getContext:function(){return{description:this.description,text:this.text}},show:function(){this.$el.showModal(),setTimeout((function(){this.$("input").select()}),0)}}),e}(AoPS.Ebooks.Views.Base);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Search"),AoPS.Ebooks.Views.Search=function(e){var t=AoPS.Ebooks.Views.Base;return e.SearchInput=t.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-search-input"),this.is_free_preview=e.is_free_preview,this.render()},getContext:function(){return{placeholder:"Search Index"}},postRender:function(){this.setupAutocomplete(),this.setupResultsVisibility()},setupAutocomplete:function(){var e=this.model,i=this,s=this.$(".ebk-search-input input");this.is_free_preview?s.on("change",(function(){s.val(""),t.showFreePreviewModal("preview-search",e)})):s.aopsAutocomplete({delay:1e3,minLength:2,source:function(t,s){e.findSearchMatches(t.term,(function(e,t){if(!e)return i.onAjaxError(t);s(_.compact(_.map(t,i.makeMatchFromData,i)))}))},onSelect:function(t,s){e.findSearchResults(s.item.value,(function(e,t){if(!e)return i.onAjaxError(t);i.displayResults(t)}))}})},setupResultsVisibility:function(){var e=this.$(".ebk-search-input input"),t=this.$(".ebk-search-results");t.hide(),e.on("input",(function(){t.hide()})),this.is_mouse_over_results=!1,this.is_search_blurred=!1;var i=this;function s(){!i.is_mouse_over_results&&i.is_search_blurred&&(t.hide(),i.is_mouse_over_results=!1)}t.mouseenter((function(){i.is_mouse_over_results=!0})).mouseleave((function(){i.is_mouse_over_results=!1,s()})),e.on("blur",(function(){i.is_search_blurred=!0,s()}))},cleanEntry:function(e){return/\$/.test(e)?null:e.replace(/!(\S)/g,": $1")},makeMatchFromData:function(e){var t=this.cleanEntry(e.entry);if(!t)return null;var i=" ("+e.count+")";return(!e.count||e.count<=1)&&(i=""),{value:e.entry,label:t+i}},onAjaxError:function(e){t.showModalError("A problem occurred while fetching the results of your search.",e);var i=this.$(".ebk-search-input input"),s=this.$(".ebk-search-results");i.val(""),i.blur(),s.hide()},displayResults:function(e){var t=this.model;function i(e){var i=_.clone(e);delete i.section_id,Backbone.trigger("ebk_goto_section",t,e.section_id,i)}1===e.length&&i(e[0]);var s=_.map(e,(function(e){var s=t.get("sections").get(e.section_id);if(!s)return"";var r=$($.parseHTML('<div class="ebk--item ebk-one-line ebk-pointer">'+s.getNumberTitle()+"</div>"));return r.click((function(){i(e)})),r}),this);this.$(".ebk-search-results").empty().append(s).show(),this.is_search_blurred=!1}}),e}(AoPS.Ebooks.Views.Search);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Toc"),AoPS.Ebooks.Views.Toc=function(e){var t=AoPS.Ebooks.Views.Base;return e.Bar=t.BaseView.extend({ITEM_MARGIN:2,MIN_SECTIONS:3,initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-toc-bar"),this.total_size=e.total_size,this.should_fill_div=e.should_fill_div,this.item_size=e.item_size||5,this.horiz=!!e.horiz,this.is_free_preview=e.is_free_preview,this.current_section=null,this.item_views=[],this.model.requestLoad((function(e){e&&(this.createItemSubviews(),this.render())}),this);var t=this.model.get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.renderLoading(null)},setCurrentSection:function(e){this.current_section=e,_.each(this.item_views,(function(t){t.setCurrentSection(e)}))},setItemSizes:function(){this.should_fill_div&&(this.total_size=parseInt(this.$el.width(),10));var e=this.computeItemSizes();_.each(this.item_views,(function(t,i){t.setTotalSize(e[i])}))},computeItemSizes:function(){var e=this.model.get("chapters").map((function(e){return Math.max(e.get("sections").length,this.MIN_SECTIONS)}),this);if(!this.total_size)return e.map((function(e){return e*this.item_size}),this);var t=this.model.get("chapters").length*this.ITEM_MARGIN,i=_.reduce(e,(function(e,t){return e+t}),0),s=this.total_size-t,o=0;return _.map(e,(function(e,t){var h=o;return o+=s*e/i,Math.round(o)-Math.round(h)}),this)},createItemSubviews:function(){var t=this.computeItemSizes();this.clearLocation("@item"),this.item_views=[],this.model.get("chapters").each((function(i,s){var o=new e.Item({model:i,current_section:this.current_section,horiz:this.horiz,is_free_preview:this.is_free_preview,total_size:t[s]});this.item_views.push(o),this.addSubviewToLocation(o,"@item")}),this)},postRender:function(){this.setItemSizes(),this.$el.toggleClass("ebk--horiz",this.horiz),this.delayedRecompute||(this.delayedRecompute=_.debounce(_.bind(this.setItemSizes,this),100),$(window).off("resize",this.delayedRecompute)),$(window).on("resize",this.delayedRecompute)},onOfflineChange:function(e,t){_.each(this.item_views,(function(e){e.links_enabled=!t}),this)}}),e.Item=t.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-toc-bar-item"),this.current_section=e.current_section||null,this.total_size=e.total_size,this.horiz=!!e.horiz,this.is_free_preview=e.is_free_preview,this.hover_section=null,this.links_enabled=!0,this.render()},getContext:function(){return{label:this.model.getTocNumber()}},postRender:function(){this.updateElSize(),this.$el.toggleClass("ebk--horiz",this.horiz),this.updateOrderClass(),this.hover_tip=this.$(".ebk--hover-tip"),this.hover_tip.toggle(!!this.hover_section),this.$el.addClass("ebk-pointer"),this.$el.on("click",_.bind(this.onClick,this)),this.$el.on("mousemove",_.bind(this.onMove,this)),this.$el.on("mousewheel",_.bind(this.clearHoverSection,this)),this.$el.on("mouseleave",_.bind(this.clearHoverSection,this))},getEventPosition:function(e){return this.horiz?e.pageX-this.$el.offset().left:e.pageY-this.$el.offset().top},getHoverSection:function(e){var t=this.model.get("sections").length*(e/this.total_size);return t=Math.floor(t),this.model.get("sections").at(t)},setCurrentSection:function(e){this.current_section=e,this.updateOrderClass()},setTotalSize:function(e){this.total_size=e,this.updateElSize(),this.clearHoverSection()},updateElSize:function(){this.$el.css(this.horiz?"width":"height",this.total_size+"px")},updateOrderClass:function(){var e=this.model.get("order"),t=-100;this.current_section&&(t=this.current_section.get("chapter").get("order")),this.$el.removeClass("ebk--passed ebk--later ebk--current"),e<t?this.$el.addClass("ebk--passed"):e>t?this.$el.addClass("ebk--later"):this.$el.addClass("ebk--current")},clearHoverSection:function(){this.hover_section=null,this.hover_tip.hide()},onMove:function(e){var t=this.getEventPosition(e),i=this.getHoverSection(t),s=t-(this.horiz?this.hover_tip.width():this.hover_tip.height())/2-4;i?this.hover_section&&i.id===this.hover_section.id||(this.hover_section=i,this.hover_tip.find("div").html(i.getNumberTitle()),this.hover_tip.css(this.horiz?"left":"top",s+"px"),this.hover_tip.show()):this.hover_tip.hide()},onClick:function(e){this.is_free_preview?t.showFreePreviewModal("preview-toc-navigation",this.model.get("book")):this.hover_section&&this.links_enabled&&($(window).scrollTop(0),Backbone.trigger("ebk_goto_section",this.model.get("book"),this.hover_section.id))}}),e}(AoPS.Ebooks.Views.Toc);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Section"),AoPS.Ebooks.Views.Section=function(e){var t=AoPS.View.compileTemplate,i=AoPS.Feed,s=AoPS.Ui,o=AoPS.Ui.Modal,n=AoPS.Ebooks.Views.Base,r=AoPS.Ebooks.Url.main;function a(e,t){!function(e,t){_.each(t.find(".ebk-sb-inline-marker"),(function(t){t=$(t);var i=$("<img>").addClass("ebk-sb-right-icon");!function(){var e;if(t.hasClass("ebk-sb-inline-marker-warning"))e=r.getImage("aopsvoln-bomb.png");else if(t.hasClass("ebk-sb-inline-marker-tough"))e=r.getImage("aopsvoln-needle.png");else{if(!t.hasClass("ebk-sb-inline-marker-important"))return;e=r.getImage("aopsvoln-eyeball.png")}i.attr("src",e)}(),i.css("top",t.position().top),e.$el.prepend(i);var s=setInterval((function(){t.parents("html").length?i.css("top",t.position().top):clearInterval(s)}),1e3)}))}(e,t),function(e,t){var i=AoPS.Ebooks.Admin&&AoPS.Ebooks.Admin.Section;if(e.model.get("edge"))return i&&i.mangleDataHrefsEdge(e,t);var s=e.model.get("book");function o(){n.showFreePreviewModal("preview-cross-reference",s)}function r(e){e.attr("title","This is a hyperlink in the full ebook. The link is disabled in this preview."),e.click(o),e.removeAttr("data-href-section")}_.each(t.find("a[data-href-section]"),(function(t){var i=(t=$(t)).attr("data-href-section"),o=s.getFragmentCodeFromId(i);e.is_free_preview?r(t):(t.attr("href",e.url_table.getUrl("section",o)),t.attr(e.stay_attr,"1")),t.removeAttr("data-href-section")})),_.each(t.find("a[data-href-label]"),(function(t){var i=(t=$(t)).attr("data-href-label");e.is_free_preview?r(t):(t.attr("href",e.url_table.getUrl("label",i)),t.attr(e.stay_attr,"1")),t.removeAttr("data-href-label")}))}(e,t),function(e,t){var i=$($.parseHTML('<div class="btn btn-primary">Show Solution</div>'));_.each(t.find(".ebk-sb-solution-hide"),(function(e){e=$(e);var t=i.clone();t.click((function(){t.hide(),e.show()})),e.before(t)}))}(0,t)}return e.Main=n.BaseView.extend({initialize:function(e){this.$el.addClass("ebk-section-body"),this.url_table=e.url_table,this.stay_attr=e.stay_attr,this.is_free_preview=e.is_free_preview,this.full=e.full,this.listenTo(this,"show",this.attemptLoad),this.attemptLoad();var t=this.model.get("book").get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.renderLoading()},attemptLoad:function(){this.load_done?this.model.markViewed():this.load_in_progress||(this.load_in_progress=!0,this.model.requestLoad((function(e,t){if(this.load_in_progress=!1,this.load_done=!0,e||!t||"E_LOAD_INTERRUPT"!==t.error_code)return e?void this.render():this.renderError(t);this.load_done=!1}),this))},render:function(){this.$el.empty(),this.$el.html(this.model.get("html")),a(this,this.$el);var e=AoPS.Ebooks.Admin&&AoPS.Ebooks.Admin.Section;e&&(e.makeAdminBar(this),e.setupAdminHacks(this)),this.manglePartBlocks(),this.makeParAnchor(),this.makeJumpButtons(),this.makeFeedButtons(),this.makeProbSubs(),this.makeHints(),this.makeVideos(),this.full?this.makeFooter():this.makeFakeFooter(),this.setupLicenseModal(),this.redrawLatex(),this.processShownObject(this.shown_obj),delete this.shown_obj,this.rendered=!0},reloadContent:function(){this.model.reload&&(this.model.reload((function(e,t){e||n.showModalError("An error occurred while reloading.",t),this.render()}),this),this.renderLoading())},showObject:function(e){e&&(this.rendered?this.processShownObject(e):this.shown_obj=e)},makeFooter:function(){if(!this.model.get("edge")){var e=this.model,i=t("#ebk-tpl-section-body-footer"),s=$($.parseHTML(i())),o=this.model.getRelativeSectionId("section",1),r=s.find(".ebk--next");this.is_free_preview?r.click(l):o?r.click(_.partial(d,o)):r.hide();var a=this.model.getRelativeSectionId("section",-1),h=s.find(".ebk--previous");this.is_free_preview?h.click(l):a?h.click(_.partial(d,a)):h.hide(),s.find(".ebk--top").click((function(){$(window).scrollTop(0)})),this.$el.append(s)}function l(){n.showFreePreviewModal("preview-footer-nav",e.get("book"))}function d(t){$(window).scrollTop(0),Backbone.trigger("ebk_goto_section",e.get("book"),t)}},makeFakeFooter:function(){var e=t("#ebk-tpl-fake-section-body-footer"),i=$($.parseHTML(e()));i.find(".ebk--top").click((function(){$(window).scrollTop(0)})),this.$el.append(i)},processShownObject:function(e){if(e&&!this.model.get("edge")){var t,i;if(e.search)return t=this.locateSearchResult(e.search,i),void this.highlightElement(t);var s=!1;if(e.label_id?i=this.$('a[data-labelid="'+e.label_id+'"]').first():e.paragraph_id?(i=this.$('p[data-parid="'+e.paragraph_id+'"]').first(),s=!0):e.problem_id&&(i=this.$('div[data-probid="'+e.problem_id+'"]').first()),i&&i.length){var o=this.$el.parents(".aops-scroll-inner").first();o.length?o.scrollTop(o.scrollTop()+i.offset().top-o.offset().top-100):$(window).scrollTop(i.offset().top-100),s&&this.highlightElement(i),setTimeout((function(){o.length?o.scrollTop(o.scrollTop()+i.offset().top-o.offset().top-100):$(window).scrollTop(i.offset().top-100)}),1e3)}}},highlightElement:function(e){e&&e.length&&(e.parents(".ebk-sb-example").length?e.css("background-color","#F04B23"):e.css("background-color","#FF7"))},locateSearchResult:function(e,t){function i(e){return _.compact(e.split(/\s/)).join(" ")}if(!t)return this.$(".ebk-sb-header").first();var s=_.find(t.find("[data-def]"),(function(t){var s=$(t).attr("data-def"),o=_.map(s.split(";"),i);return _.contains(o,e)}));return(s=$(s))&&s.html().length?s:t},manglePartBlocks:function(){_.each(this.$(".ebk-sb-part-label"),(function(e){var t=$(e.nextSibling),i=!t.next().length;function s(){t.height()>20&&t.css("vertical-align","top")}e=$(e),i&&t.hasClass("latexcenter")?(t.css({display:"inline-block",padding:"0"}),t.on("load",s),setTimeout(s,5e3)):i&&t.hasClass("ebk-sb-image")&&(t.css({display:"inline-block",width:"99%"}),t.on("load",s),setTimeout(s,5e3))}))},makeJumpButtons:function(){var e=t("#ebk-tpl-section-body-jump-button");_.each(this.$(".ebk-sb-preview"),_.bind((function(t){var i=(t=$(t)).attr("data-preview-probid"),s=this.$('.ebk-sb-example[data-probid="'+i+'"]').first();if(s.length){var o=$($.parseHTML(e()));o.click(_.bind((function(){var e=this.$el.parents(".aops-scroll-inner").first();e.length?e.scrollTop(e.scrollTop()+s.offset().top-e.offset().top-100):$(window).scrollTop(s.offset().top-100)}),this)),t.find(".ebk-sb--top-right").append(o)}}),this))},makeFeedButtons:function(){if(i){var e=this.model.get("book");_.each(this.$(".ebk-sb-problem, .ebk-sb-example"),(function(s){if(s=$(s),this.is_free_preview)s.find(".ebk-sb--top-right").append(AoPS.bd.is_community_active?[$("<div></div>").text("t").addClass("open-feed-btn").click(t).attr("title","View discussions about this"),$("<div></div>").text("V").addClass("new-topic-btn").click(t).attr("title","Start topic about this")]:[]);else if(AoPS.bd.is_community_active){var o=s.attr("data-probid");if(o||(o=s.find("div[data-probid]").first().attr("data-probid"))){var n=this.model.get("fragment_code"),r=this.url_table.getUrl("section_problem",n,o),a=function(e){if(e.hasClass("ebk-sb-example"))return e.find(".ebk-sb-example-number").text().trim();var t=e.find(".ebk-sb--number").text();return t=t.replace(/:/g,""),/^(Problem|Exercise)/.test(t)?t:e.hasClass("ebk-sb--exercise")?"Exercise "+t:"Problem "+t}(s),h=this.model.getTags().concat([a]),l=i.buildOpenFeedButton({category_id:e.get("cmty_category_id"),subtitle:a,tag_text:r}),d=i.buildNewTopicButton({category_id:e.get("cmty_category_id"),tags:h,linked_tag:a,target_url:r,target_text:a,subtitle:a,hidden_tags:[this.url_table.getUrl("section",n)]});s.find(".ebk-sb--top-right").append([l,d])}}}),this)}function t(){n.showFreePreviewModal("preview-community-problem",e)}},makeProbSubs:function(){if(!this.model.get("edge")){var t=$($.parseHTML('<div class="ebk-clear"></div>')),i=_.bind((function(t){var i=$(t).attr("data-probid");if(!i)return null;var s=this.model.getOrCreateProblem(i);return new e.ProbSub({model:s,is_free_preview:this.is_free_preview,parent_view:this})}),this);_.each(this.$(".ebk-sb-problem.ebk-sb-problem-nosol"),(function(e){$(e).attr("data-probid",""),$(e).find(".ebk-sb--main").append(t.clone(),$($.parseHTML("<em>This problem is open-ended and has no provided solution, so you cannot submit work for it.</em>")))}),this),this.prob_subs=[],_.each(this.$(".ebk-sb-problem"),(function(e){var s=i(e);s&&($(e).find(".ebk-sb--main").append(t.clone(),s.$el),this.prob_subs.push(s))}),this),_.each(this.$(".ebk-sb-problem .ebk-sb-part"),(function(e){var s=i(e);s&&($(e).after(t.clone(),s.$el),this.prob_subs.push(s))}),this)}},makeHints:function(){var t=this.$(".ebk-sb-hint");this.model.get("edge")||_.each(t,(function(t){var i=$(t).attr("data-hintid");if(i){var s=this.model.getOrCreateHint(i),o=new e.Hint({model:s,is_free_preview:this.is_free_preview,parent_view:this});$(t).replaceWith(o.$el)}}),this)},makeVideos:function(){_.each(this.$(".ebk-sb-video-container"),(function(e){e=$(e);var t=new Backbone.Model({thumbnail_youtube_id:e.attr("data-youtubeid"),thumbnail_video_title:e.attr("data-videotitle"),thumbnail_video_id:e.attr("data-videoid"),thumbnail_video_url:e.attr("data-videourl")}),i=new AoPS.Videos.Views.ThumbnailView({model:t});i.render(),i.$("a").attr("target","_blank");var s=$("<div></div>").addClass("links-thumbnail-panel");s.append(i.$el),e.append(s)}),this)},makeParAnchor:function(){var t=$($.parseHTML('<div class="ebk-section-body-gutter"></div>'));this.$el.prepend(t);var i=new e.ParAnchor({model:this.model.get("book"),edge:this.model.get("edge"),url_table:this.url_table,is_free_preview:this.is_free_preview,$par:null});t.append(i.$el),this.$(".ebk-sb-par-marker-container").on("mouseenter",(function(e){i.setParEl($(e.currentTarget))})),this.$el.on("mouseleave",(function(e){i.setParEl(null)}))},setupLicenseModal:function(){var e=this.model.get("book");this.$(".ebk-sb--show-license").click((function(){var i="The Purchaser agreed to the terms of this Agreement on "+e.get("start_access_at");e.get("start_access_at")||(i="The Purchaser agreed to the terms of this Agreement at the time of purchase of this ebook license.");var s=t("#ebk-tpl-store-license")()+"<p>"+i+"</p>";o.showAlert(s,{scrollable:!0})}))},redrawLatex:function(){var e=this.$(".latex, .latexcenter"),t=function(){_.each(e,(function(e){var t,i;t=$(e),i=t.css("display"),t.hide(0,(function(){$(this).css("display",i)}))}))};setTimeout(t,100),setTimeout(t,500),setTimeout(t,1e3)},onOfflineChange:function(e,t){n.enableHrefs(this.$el,!t)}}),e.Hint=n.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-section-body-hint"),this.parent_view=e.parent_view,this.is_free_preview=e.is_free_preview;var t=this.model.get("book").get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.render()},getContext:function(){return{is_shown:this.model.get("is_shown"),hint_html:this.model.get("hint_html")}},postRender:function(){this.parent_view&&a(this.parent_view,this.$el),this.$(".ebk-sb-show-hint").click(_.bind(this.onViewHint,this)),this.$(".ebk-sb-hide-hint").click(_.bind(this.onHideHint,this))},onViewHint:function(){this.model.view((function(e,t){e?this.render():n.showModalError("A problem occurred while fetching the hint.",t)}),this)},onHideHint:function(){this.model.set("is_shown",!1),this.render()},onOfflineChange:function(e,t){this.$(".ebk-sb-show-hint").toggle(!this.model.get("hint_html")&&!t)}}),e.ProbSub=n.BaseView.extend({AUTOSAVE_DELAY:1e3,initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-section-body-prob-sub"),this.parent_view=e.parent_view,this.is_free_preview=e.is_free_preview,this.parent_view&&this.listenTo(this.parent_view,"show",this.render);var t=this.model.get("book").get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.render()},getContext:function(){var e=this.model;return{has_submitted:e.get("has_submitted"),has_soln_perms:e.get("has_soln_perms")||this.is_free_preview,submission_before:e.get("submission_before"),submission_before_html:e.get("submission_before_html"),submission_after:e.get("submission_after"),submission_after_html:e.get("submission_after_html"),solution_html:e.get("solution_html"),before_placeholder:"Type your solution, notes and/or work here.",after_placeholder:"You may type any additional notes you have here.",soln_denied:"You don't have permission to view the solution to this problem."}},postRender:function(){this.parent_view&&a(this.parent_view,this.$el),this.makeTextareaDynamic();var e=this.$("textarea");e.length&&(this.updateButtonState(),e.on("input",_.bind(this.onSubmissionChange,this))),this.$(".ebk-sb--save-status").hide(),this.$(".ebk-sb--rendered-text-holder").hide(),this.$(".ebk-sb--show-sol").click(_.bind(this.onShowSolution,this)),this.$(".ebk-sb--hide-sol").click(_.bind(this.onHideSolution,this)),this.$(".ebk-sb--reset").click(_.bind(this.onReset,this)),this.toggleSolution(!!this.model.get("has_submitted")),this.model.get("has_soln_perms")||this.is_free_preview||this.$(".ebk-sb--show-sol").text("Submit"),this.previewRenderedSubmission()},makeTextareaDynamic:function(){var e=this.$("textarea");if(e.length)var t=setInterval((function(){e.parents("html").length>0&&(clearInterval(t),s.autoExpandTextarea(e))}),100)},updateButtonState:function(){var e=this.$(".ebk-sb--show-sol"),t=this.$(".ebk-sb--reset");this.submitWhenDisabled=this.submitWhenDisabled||_.bind((function(){this.is_offline?o.showAlert("You cannot perform this action in offline mode. If you have internet access right now, use the button in the top right of the page to reenable this action."):o.showAlert("<p>You must type in a response for this problem before the system will let you submit it or view its solution.</p>")}),this);var i=this.$("textarea").val().trim();this.show_disabled=!(this.model.get("has_submitted")||i&&!this.is_offline),e.toggleClass("disabled",this.show_disabled),e.off("click",this.submitWhenDisabled),this.show_disabled?(e.css("pointer-events","auto"),e.attr("title",this.is_offline?"You can't submit in offline mode.":"Please input a response first."),e.on("click",this.submitWhenDisabled)):(e.css("pointer-events",""),e.removeAttr("title")),t.toggleClass("disabled",!!this.is_offline),this.is_offline?(t.css("pointer-events","auto"),t.attr("title","You can't reset in offline mode.")):(t.css("pointer-events",""),t.removeAttr("title"))},flashSavedIndicator:function(){var e=this.$(".ebk-sb--save-status");e.finish(),e.show(),setTimeout((function(){e.fadeOut()}),1500)},previewRenderedSubmission:function(){var e=this.model.get("has_submitted")?this.model.get("submission_after_html"):this.model.get("submission_before_html"),t=this.$(".ebk-sb--rendered-text-holder");_.isNull(e)||""===e?t.hide():(t.html('<span class="ebk-sb--header">Preview:</span> '+e),t.show())},submitProblem:function(e){if(!this.is_offline){var t=this.is_free_preview?"loading the solution":"saving your submission";this.is_free_preview&&e?this.model.viewPreviewSolution(this.$("textarea").val(),i,this):this.is_free_preview||this.model.submitProblem(this.$("textarea").val(),e,i,this)}function i(i,s){i?e?(this.render(),this.toggleSolution(!0),this.$(".ebk-sb--rendered-text-holder").hide()):(this.flashSavedIndicator(),this.previewRenderedSubmission()):"E_AJAX_FILTERED"!==s.error_code&&n.showModalError("An error occurred while "+t+".",s)}},toggleSolution:function(e){this.$(".ebk-sb--show-sol").toggle(!e),this.$(".ebk-sb--hide-sol").toggle(!(!e||!this.model.get("has_soln_perms"))),this.$(".ebk-sb--reset").toggle(!!this.model.get("has_submitted")),this.$(".ebk-sb-user-sub-final").toggle(!!e),this.$(".ebk-sb-solution").toggle(!!e)},onSubmissionChange:function(){this.updateButtonState(),this.is_free_preview||(this.delayedSubmit||(this.delayedSubmit=_.debounce(_.bind(this.submitProblem,this,!1),this.AUTOSAVE_DELAY)),this.delayedSubmit())},onShowSolution:function(){this.show_disabled||(this.model.get("has_submitted")?this.toggleSolution(!0):this.is_offline||this.submitProblem(!0))},onHideSolution:function(){this.toggleSolution(!1)},onReset:function(){function e(e,t){if(!e)return n.showModalError(t);this.render()}this.is_offline||o.showConfirm("This will permanently remove your submissions and hide the solution until your next submission. Are you sure?",_.bind((function(t){t&&(this.is_free_preview?this.model.resetProblemLocal(e,this):this.model.resetProblem(e,this))}),this))},onOfflineChange:function(e,t){this.is_offline=t,this.updateButtonState()}}),e.ParAnchor=n.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-section-body-par-anchor"),this.url_table=e.url_table,this.edge=e.edge,this.$par=e.$par,this.is_free_preview=e.is_free_preview;var t=this.model.get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.render()},postRender:function(){this.followPar(),this.$el.off("click"),this.$el.click(_.bind(this.onClick,this))},setParEl:function(e){this.$par=e,this.render()},followPar:function(){var e=_.bind((function(){var e=this.$par.offset().top,t=this.$el.offsetParent().offset().top,i=this.$par.height(),s=this.$el.height();this.$el.show().css("top",e-t+i/2-s/2+"px")}),this);this.$par&&$.contains(document.documentElement,this.$par[0])&&!this.is_offline?(e(),e()):this.$el.hide()},onOfflineChange:function(e,t){this.is_offline=t,this.followPar()},onClick:function(){if(!this.edge&&this.$par)if(this.is_free_preview)n.showFreePreviewModal("preview-paragraph-url",this.model);else{var e=this.url_table.getUrl("paragraph",this.$par.attr("data-parid")),t=window.location.href.replace(/([^\/]+):\/\/([^\/]+)\/(.*)$/,"$1://$2"+e);new n.CopyTextModal({description:"The URL for this paragraph is:",text:t}).show()}}}),e}(AoPS.Ebooks.Views.Section);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Book"),AoPS.Ebooks.Views.Book=function(e){var t=AoPS.Feed,i=AoPS.Ebooks.Views.Base,s=AoPS.Ebooks.Views.Search,o=AoPS.Ebooks.Views.Toc,n=AoPS.Ebooks.Views.Section;return e.Main=i.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-book-main"),this.full=!1!==e.full,this.url_table=e.url_table,this.stay_attr=e.stay_attr,this.body_view_cache={};var t=this.model.get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.createSubviews(),this.model.requestLoad((function(e,t){if(!e)return this.renderError(t);this.render()}),this),this.renderLoading()},createSubviews:function(){this.full?(this.header_view_obj=new e.Header({model:this.model,url_table:this.url_table,stay_attr:this.stay_attr}),this.addSubviewToLocation(this.header_view_obj,"@header"),this.toc_bar_view_obj=new o.Bar({model:this.model,link_size:5}),this.addSubviewToLocation(this.toc_bar_view_obj,"@toc")):(this.header_view_obj=new e.FakeHeader({model:this.model,url_table:this.url_table,stay_attr:this.stay_attr}),this.addSubviewToLocation(this.header_view_obj,"@header"))},showSection:function(e,t){this.model.requestLoad((function(i){if(i){this.full&&this.toc_bar_view_obj.setCurrentSection(e),this.header_view_obj.setCurrentSection(e);var s=this.getOrCreateBody(e);this.showBody(s),s.showObject(t)}}),this)},showError:function(e){this.showHtmlAsBody(this.getErrorBox({error_msg:e,footer:"Please use the bar on the left to return to reading the book."}))},getOrCreateBody:function(e){var t=this.body_view_cache[e.id];return t||(t=new n.Main({model:e,url_table:this.url_table,stay_attr:this.stay_attr,full:this.full}),this.body_view_cache[e.id]=t),t},showBody:function(e){this.current_body&&this.current_body.$el.detach(),this.$(".ebk-section-container").empty().append(e.$el),this.current_body=e,e.trigger("show")},showHtmlAsBody:function(e){this.current_body&&this.current_body.$el.detach(),this.$(".ebk-section-container").html(e),this.current_body=null},onOfflineChange:function(e,t){this.$el.toggleClass("ebk-offline-mode",!!t)}}),e.Header=i.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-book-header"),this.section_model=null,this.url_table=e.url_table,this.stay_attr=e.stay_attr,this.is_free_preview=e.is_free_preview;var t=this.model.get("master");this.listenTo(t,"change:is_offline",this.onOfflineChange),this.createSubviews(),this.render()},events:{"click .ebk--fullscreen":"onFullscreen","click .ebk--offline":"onOfflineClick"},setCurrentSection:function(e){this.section_model&&this.stopListening(this.section_model),this.section_model=e,this.listenTo(this.section_model,"change:alcumus_subject_id change:alcumus_topic_id",this.render),this.render()},createSubviews:function(){this.clearLocation("@search");var e=new s.SearchInput({model:this.model,is_free_preview:this.is_free_preview});this.addSubviewToLocation(e,"@search")},getContext:function(){var e,i=this.section_model,s={stay_attr:this.stay_attr,has_feed:!!t,alcumus_url:i&&i.getAlcumusUrl(),book_id:this.model.id,index_url:this.url_table?this.url_table.getUrl("index"):"#",cover_url:this.model.getCoverUrl(),chapter_title:"",chapter_title_simple:"",section_title:"",section_title_simple:""};return this.model.get("master").get("is_embedded")&&delete s.alcumus_url,i&&(e=i.get("chapter"),s.chapter_title=e&&e.getNumberTitle({full:!0}),s.chapter_title_simple=e&&e.get("title_html"),s.section_title=i.getNumberTitle(),s.section_title_simple=i.get("title_html")),s},postRender:function(){this.setupBookNavigation(),this.finishFeedButtons(),this.doFreePreviewMangling()},doFreePreviewMangling:function(){if(this.is_free_preview){var e=this.model;this.$(".ebk--cover-image a").removeAttr("href").addClass("ebk-pointer").click((function(){i.showFreePreviewModal("preview-cover-navigation",e)}))}},setupBookNavigation:function(){var e=this.model,t=this.section_model;function s(){i.showFreePreviewModal("preview-header-navigation",e)}var o=_.bind((function(i,o,n){var r=t&&t.getRelativeSectionId(o,n),l=r&&e.getFragmentCodeFromId(r);this.is_free_preview?(i.find("a").removeAttr("href").attr("title","This is a navigation button in the full ebook. The link is disabled in the preview.").click(s),i.show()):r?(i.find("a").attr("href",this.url_table.getUrl("section",l)),i.show()):(i.find("a").attr("href","#"),i.hide())}),this);o(this.$(".ebk--prev-chapter"),"chapter",-1),o(this.$(".ebk--next-chapter"),"chapter",1),o(this.$(".ebk--prev-section"),"section",-1),o(this.$(".ebk--next-section"),"section",1)},finishFeedButtons:function(){var e=this.model,s=this.section_model;if(!s||!t)return this.$(".ebk--community").hide(),void this.$(".ebk--new-topic").hide();if(this.is_free_preview)this.$(".ebk--community, .ebk--new-topic").click((function(){i.showFreePreviewModal("preview-community-section",e)}));else{var o=s.getFeedData(this.url_table);t.buildOpenFeedButton({$button:this.$(".ebk--community"),category_id:o.category_id,tag_text:o.main_url,subtitle:o.subtitle}),t.buildNewTopicButton({$button:this.$(".ebk--new-topic"),category_id:o.category_id,tags:o.tags,linked_tag:o.tags[o.tags.length-1],target_url:o.main_url,target_text:o.subtitle,subtitle:o.subtitle})}},onFullscreen:function(){$("body").hasClass("fullscreen")?($("body").removeClass("fullscreen"),this.$(".ebk--fullscreen span.aops-font").text("P")):($("body").addClass("fullscreen"),this.$(".ebk--fullscreen span.aops-font").text("s"))},onOfflineClick:function(){var e=this.model.get("master");e.set("is_offline",!e.get("is_offline"))},onOfflineChange:function(e,t){i.enableHrefs(this.$el,!t)}}),e.FakeHeader=i.BaseView.extend({initialize:function(e){this.setTemplateAndUseRootEl("ebk-tpl-book-fake-header"),this.render()},setCurrentSection:function(e){this.section_model&&this.stopListening(this.section_model),this.section_model=e,this.listenTo(this.section_model,"change:alcumus_subject_id change:alcumus_topic_id",this.render),this.render()},getContext:function(){var e=this.section_model,t={cover_url:this.model.getCoverUrl()};if(this.model.get("master").get("is_embedded")&&delete t.alcumus_url,e){var i=e.get("chapter");t.chapter_title=i&&i.getNumberTitle({full:!0})}return t}}),e.FreePreviewMain=i.BaseView.extend({initialize:function(){this.setTemplateAndUseRootEl("ebk-tpl-free-preview-main"),this.model.loadFreePreview((function(t,i){if(!t)return this.renderError(i);this.section_model=i,this.section_model?(this.header_view=new e.Header({model:this.model,is_free_preview:!0}),this.header_view.setCurrentSection(this.section_model),this.addSubviewToLocation(this.header_view,"@header"),this.toc_bar_view_obj=new o.Bar({model:this.model,link_size:5,is_free_preview:!0}),this.toc_bar_view_obj.setCurrentSection(this.section_model),this.addSubviewToLocation(this.toc_bar_view_obj,"@toc"),this.body_view=new n.Main({model:this.section_model,is_free_preview:!0,full:!0}),this.addSubviewToLocation(this.body_view,"@body"),this.render()):this.$el.text("This book does not have a freely available preview.")}),this),this.renderLoading()}}),e}(AoPS.Ebooks.Views.Book);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","Views","Index"),AoPS.Ebooks.Views.Index=function(e){var t=AoPS.View.compileTemplate,o=AoPS.Ui.Modal,i=AoPS.Ebooks.Views.Base,n=AoPS.Ebooks.Views.Search,s=AoPS.Ebooks.Views.Toc;return e.Intro=i.BaseView.extend({initialize:function(){this.setTemplateAndUseRootEl("ebk-tpl-index-intro"),this.render()},postRender:function(){var e={},o=t("#ebk-tpl-store-intro")(e);this.$(".ebk-landing-top-text").html(o);var i=_.bind((function(e,t){this.$(".ebk--tab").removeClass("ebk--active"),$(t.currentTarget).addClass("ebk--active"),this.$(".ebk--tab-contents").html(e)}),this),n=t("#ebk-tpl-store-how-it-works")(e);this.$(".ebk-landing-tab-how-it-works").on("click",_.partial(i,n)),this.$(".ebk--tab-contents").html(n);var s=t("#ebk-tpl-store-titles")(e);this.$(".ebk-landing-tab-titles").on("click",_.partial(i,s));var r=t("#ebk-tpl-store-faq")(e);this.$(".ebk-landing-tab-faq").on("click",_.partial(i,r))}}),e.Main=i.BaseView.extend({initialize:function(){this.setTemplateAndUseRootEl("ebk-tpl-index"),this.model.requestLoad((function(t,o){if(!t)return this.renderError(o);this.model.getAccessibleBooks().each((function(t){var o=new e.BookListItem({model:t});this.addSubviewToLocation(o,"@book")}),this),this.render(),AoPS.fixSidebarAnimatedOnceOnElement(3e3,"ebk-loc-index"),$(window).on("resize",(function(){AoPS.fixSidebarAnimatedOnceOnElement(1,"ebk-loc-index")}))}),this),this.renderLoading()},getContext:function(){return{has_books:!!this.model.getAccessibleBooks().length,is_admin:!!this.model.get("is_admin")}}}),e.BookListItem=i.BaseView.extend({initialize:function(){this.setTemplateAndUseRootEl("ebk-tpl-index-book-item"),this.renderLoading(null),this.model.requestLoad((function(e,t){if(!e)return this.renderError(t);this.createHeaderButtons(),this.createChapterList(),this.createTocBar(),this.render()}),this)},events:{"click .ebk--cancel":"onCancelPurchase","click .ebk--reset":"onResetBook"},getContext:function(){var e=this.model;return{store_sku:e.get("store_sku"),title:e.get("title"),by:e.getByLine(),cover_url:e.getCoverUrl(),can_cancel:e.get("can_cancel")}},postRender:function(){var e,t;this.toc_bar&&(e=this.model.get("last_viewed_section_id"),t=this.model.get("sections").get(e),this.toc_bar.setCurrentSection(t))},createChapterList:function(){var t=Math.ceil(this.model.get("chapters").length/2);this.clearLocation("@chapter_left"),this.clearLocation("@chapter_right"),this.model.get("chapters").each((function(o,i){var n=new e.BookChapter({model:o}),s=i<t?"@chapter_left":"@chapter_right";this.addSubviewToLocation(n,s)}),this)},createTocBar:function(){this.clearLocation("@toc_bar"),this.toc_bar=new s.Bar({model:this.model,horiz:!0,should_fill_div:!0}),this.addSubviewToLocation(this.toc_bar,"@toc_bar")},createHeaderButtons:function(){this.clearLocation("@button_header"),this.addSubviewToLocation(new n.SearchInput({model:this.model}),"@button_header")},onCancelPurchase:function(){var e=t("#ebk-cms-cancel-confirm"),n=t("#ebk-cms-cancel-done"),s=this.model,r={title:this.model.get("title")};o.showConfirm(e(r),(function(e){var t=$(".aops-modal-wrapper").find(".ebk-cancel-reason").val();e&&function(e){s.cancelPurchase(e,(function(e,t){e?o.showAlert(n(r),{onClose:function(){window.location.reload()}}):i.showModalError("An error occurred when cancelling your purchase.",t)}))}(t)}),{confirm_button_cancel:"Keep Online Book",confirm_button_ok:"Cancel Purchase",onShow:function(){$(".aops-modal-wrapper").find(".aops-modal-btn").eq(1).focus()}})},onResetBook:function(){var e=t("#ebk-cms-reset-confirm"),n=t("#ebk-cms-reset-done"),s=t("#ebk-cms-reset-not-done"),r=this.model,a={title:r.get("title")};o.showConfirm(e(a),(function(e){var t=$(".aops-modal-wrapper").find(".ebk-reset-confirmation").val();e&&function(e){e&&"RESET"===e?r.resetAllProblems((function(e,t){e?(r.get("problems").each((function(e){e.resetProblem()})),o.showMessage(n(a))):i.showModalError("An error occurred when resetting all problems.",t)})):(o.closeTopModal(),setTimeout((function(){o.showMessage(s(a))}),0))}(t)}),{confirm_button_cancel:"Cancel",confirm_button_ok:"Reset All Problems",onShow:function(){$(".aops-modal-wrapper").find(".aops-modal-btn").eq(1).focus()},title:"Are you sure?"})}}),e.BookChapter=i.BaseView.extend({initialize:function(){this.setTemplateAndUseRootEl("ebk-tpl-index-book-chapter"),this.render()},events:{"click a":"onClick"},getContext:function(){return{id:this.model.id,book_id:this.model.get("book").id,number:this.model.getTocNumber(),title:this.model.get("title_html")}},onClick:function(){Backbone.trigger("ebk_goto_section",this.model.get("book"),this.model.id)}}),e}(AoPS.Ebooks.Views.Index);
;AoPS.Utils.initKeyChain(AoPS,"Ebooks","BookController"),AoPS.Ebooks.BookController=function(){var t=AoPS.Utils,e=AoPS.Ebooks.Url,o=AoPS.Ebooks.Views.Book;return t.Class.extend(_.extend({},Backbone.Events,{initialize:function(t){var i=t.book_model;this.book_model=i,this.url_table=e.createBookTable({root_url:t.root_url,book_id:i.id}),this.view=new o.Main({model:i,url_table:this.url_table,stay_attr:t.stay_attr||"data-ebk-stay",full:t.full})},getCurrentUrl:function(){if(this.current_section_id)return this.getUrl(this.current_section_id)},getUrl:function(t,e){var o=this.book_model;e=e||{},t=o.getAsSectionId(t);var i=o.get("sections").get(t);if(i){var r=i.get("fragment_code");return e.label_id?this.url_table.getUrlWithoutRoot("section_label",r,e.label_id):e.paragraph_id?this.url_table.getUrlWithoutRoot("section_paragraph",r,e.paragraph_id):e.problem_id?this.url_table.getUrlWithoutRoot("section_problem",r,e.problem_id):this.url_table.getUrlWithoutRoot("section",r)}},processUrl:function(t,e){t=t||"";var o=this.url_table.matchUrl(t,!0);o||(t&&"/"===t.slice(-1)&&(o=this.url_table.matchUrl(t.slice(0,-1),!0)),o)?this.book_model.requestLoad((function(t,i){if(!t)return this.handleError("Book "+this.book_model.id+" failed to load.",i);var r=this.book_model.getFragmentIdFromCode(o[1]);e=_.clone(e)||{},"index"===o[0]?this.showSection(null,e):"last"===o[0]?this.redirectToSection(this.book_model.get("last_viewed_section_id"),e):"section"===o[0]?this.showSection(r,e):"section_label"===o[0]?(e.label_id=o[2],this.showSection(r,e)):"section_paragraph"===o[0]?(e.paragraph_id=o[2],this.showSection(r,e)):"section_problem"===o[0]?(e.problem_id=o[2],this.showSection(r,e)):"label"===o[0]?this.findAndShowLabel(o[1],e):"paragraph"===o[0]?this.findAndShowParagraph(o[1],e):"problem"===o[0]&&this.findAndShowProblem(o[1],e)}),this):this.handleError("The URL "+t+" was not recognized.")},resyncUrlBar:function(t){(t=t||this.getCurrentUrl())&&setTimeout(_.bind((function(){this.trigger("replace_url",t)}),this),0)},showSection:function(t,e){var o=this.book_model,i=o.get("chapters").get(t),r=o.get("sections").get(t);r?(this.current_section_id=t,this.view.showSection(r,e),this.trigger("show_section",r,e),this.triggerBreadcrumbsUpdate(r,e)):i?this.redirectToSection(i.getFirstSectionId(),e):this.redirectToSection(o.getFirstSectionId(),e)},findAndShowLabel:function(t,e){this.book_model.get("has_access")?this.book_model.findLabel(t,(function(o,i){if(!o)return this.handleError("The link you provided in the URL is not valid in this book.",i);var r=i;this.redirectToSection(r,_.extend({label_id:t},e))}),this):this.trigger("force_out_of_book")},findAndShowParagraph:function(t,e){this.book_model.get("has_access")?this.book_model.findParagraph(t,(function(o,i){if(!o)return this.handleError("Paragraph "+t+" could not be found.",i);var r=i;this.redirectToSection(r,_.extend({paragraph_id:t},e))}),this):this.trigger("force_out_of_book")},findAndShowProblem:function(t,e){this.book_model.get("has_access")?this.book_model.findProblem(t,(function(o,i){if(!o)return this.handleError("Problem "+t+" could not be found.",i);var r=i;this.redirectToSection(r,_.extend({problem_id:t},e))}),this):this.trigger("force_out_of_book")},triggerBreadcrumbsUpdate:function(t,e){var o=this.book_model,i=t.get("chapter"),r=o.getFragmentCodeFromId(i.getFirstSectionId());this.trigger("breadcrumbs",[{text:i.getNumberTitle({plain:!0}),url:this.url_table.getUrl("section",r)},{text:t.getNumberTitle({plain:!0})}])},redirectToSection:function(t,e){var o=this.book_model;t=t||o.getFirstSectionId();var i=this.getUrl(t,e);i||o.get("has_access")?i?(this.trigger("replace_url",i),this.processUrl(i,e)):this.handleError("Attempted to go to section "+t+" which was not found."):this.trigger("force_out_of_book")},handleError:function(t,e){delete this.current_section,console.log(t,e),this.view.whenRendered((function(){this.view.showError(t)}),this)}}))}();
;//# sourceMappingURL=ebk_core.js.map